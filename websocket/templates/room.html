<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room_name_json }} ì±„íŒ…ë°©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <style>
        #chat-log {
            font-size: 14px;
            max-width: 1000px;
            width: 100%;
            border: 1px solid;
            height: 400px;
            overflow: auto;
        }

        #container-chat-message-input {
            max-width: 1000px;
            width: 100%;
            inline-size: -webkit-fill-available;
        }

        #user-list {
            max-width: 1000px;
            width: 100%;
            border: 1px solid;
            height: 200px;
            overflow: auto;
        }

        p.chat-message {
            margin: 3px;
        }

        p.chat-self {
            margin: 3px;
            font-weight: bold;
        }

        p.chat-message-center {
            margin: 3px;
            text-align: center;
            background-color: #f4f4f4;
        }

        p.chat-message-leave {
            margin: 3px;
            text-align: center;
            background-color: #fc9f9f;
        }

        p.chat-message-greet {
            margin: 3px;
            text-align: center;
            background-color: #dbff9e;
        }

        p.each-user {
            margin: 3px;
            font-size: 14px;
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
<div id="chat-log">
</div>
<div id="container-chat-message-input">
    <input id="chat-message-input" style="inline-size: inherit;" type="text" placeholder="ì±„íŒ… ì…ë ¥í•˜ì„¸ìš”."/><br/>
</div>
<div style="margin: 5px;">
    <input style="max-width: 1000px; width: 100%;" id="chat-message-submit" type="button" value="ì „ì†¡"/>
</div>
<div>
    <input style="color: red; display: none; max-width: 1000px; width: 100%;" onClick="window.location.reload();"
           id="chat-message-refresh" type="button" value="ì¬ì ‘ì†"/>
</div>
<div id="user-list"></div>

<!-- Modal -->
<div class="modal fade" id="reconnect-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">ğŸ™ƒ ì¬ì ‘ì†ì´ í•„ìš”í•©ë‹ˆë‹¤.</h5>
            </div>
            <div class="modal-body">
                <p>ì±„íŒ…ë°©ì— ë¬¸ì œê°€ ë°œìƒí•˜ì—¬ ì¬ì ‘ì†ì´ í•„ìš”í•œ ìƒíƒœì…ë‹ˆë‹¤~!!</p>
                <p>5ì´ˆ ë’¤, ë°”ë¡œ ì¬ì ‘ì† ë©ë‹ˆë‹¤.</p>
            </div>
            <div class="text-center mb-3 fw-bold">
                ì¬ ì ‘ì†ê¹Œì§€ <span id="left-second">5</span> ì´ˆ ë‚¨ìŒ
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onClick="window.location.reload();">ë°”ë¡œ ì¬ì ‘ì†</button>
            </div>
        </div>
    </div>
</div>

<script>
    function appendMessage(message, className = "chat-message") {
        let _p = document.createElement("p");
        _p.className = className;
        _p.innerHTML = message;
        document.querySelector('#chat-log').appendChild(_p);
    }

    function refreshUser(userSet) {
        document.querySelector('#user-list').innerHTML = "";
        userSet.forEach(([user, time]) => {
            let _p = document.createElement("p");
            _p.className = "each-user";
            _p.innerHTML = "[(ì°¸ì—¬ì‹œê°„) " + time + "] " + user;
            document.querySelector('#user-list').appendChild(_p);
        });
    }

    function countDownInnerHtml(startNumber, _dom) {
        let _startNumber = startNumber;

        const interval = setInterval(() => {
            _startNumber -= 1;
            _dom.innerHTML = _startNumber;
        }, 1000);

        if (_startNumber === 0) {
            clearInterval(interval);
        }

        return interval;
    }

    // ë°©ì´ë¦„
    const roomName = {{ room_name_json }};
    // user
    let userNickname = null;

    const reconnectModal = new bootstrap.Modal(document.getElementById('reconnect-modal'), {
        keyboard: false
    })

    // ë©”ì‹œì§€ íƒ€ì…
    const LEAVE_MSG = 0;
    const GREET_MSG = 1;
    const NORMAL_MSG = 2;

    let isNotificationAble = true;

    // jsì—ì„œ ì œê³µí•˜ëŠ” WebSocket ì‚¬ìš©
    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName);

    // ì¬ì ‘ì†í•˜ëŠ” ëª¨ë‹¬ ì°½ ê´€ë¦¬
    const reConnectModal = document.getElementById('reconnect-modal');

    // Notification ê¶Œí•œ ìš”ì²­
    if (Notification.permission !== "granted") {
        Notification.requestPermission((permission) => {

        });
    }

    // ë©”ì„¸ì§€ê°€ ìˆì„ ê²½ìš°? ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•œë‹¤
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data['message_type'] === NORMAL_MSG) { // ì¼ë°˜ ë©”ì‹œì§€ í†µì‹ 
            // ìê¸° ìì‹ ì¸ ê²½ìš°
            if (data['username'] === userNickname) {
                appendMessage(data['message'], "chat-self");
            } else {
                if (isNotificationAble) {
                    new window.Notification(data['username'], {body: data['message']});

                    isNotificationAble = false;
                    setTimeout(() => {
                        isNotificationAble = true;
                    }, 5000);
                }
                appendMessage(data['message']);
            }
        } else if (data['message_type'] === LEAVE_MSG) { // ë‚˜ê°€ëŠ” ê²½ìš°
            appendMessage(data['message'], "chat-message-leave");

            const userListObj = Object.entries(JSON.parse(data['current_user_set']));
            refreshUser(userListObj);
        } else if (data['message_type'] === GREET_MSG) { // ì°¸ì—¬í•˜ëŠ” ê²½ìš°
            appendMessage(data['message'], "chat-message-greet");
            if (!userNickname) {
                userNickname = data['username'];
            } else {
                // ë‚´ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì‚¬ëŒì´ ì°¸ê°€í–ˆì„ ê²½ìš° Notification ë‚ ë¦¬ê¸°
                new window.Notification(data['username'], {body: `${data['username']} ë‹˜ì´ ì°¸ê°€í•˜ì…¨ìŠµë‹ˆë‹¤.`});
            }

            const userListObj = Object.entries(JSON.parse(data['current_user_set']));
            refreshUser(userListObj);
        } else {
            appendMessage(data['message']);
        }
        document.querySelector('#chat-log').scrollTop = document.querySelector('#chat-log').scrollHeight;
    };

    // ì†Œì¼“ì´ ë‹«íˆë©´ ëŠëŠ”ë‹¤
    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');

        // ì¬ì ‘ì† ëª¨ë‹¬ ë„ìš°ê¸°
        reconnectModal.show();

        const left_second_div = document.querySelector("#left-second");
        const interval = countDownInnerHtml(Number(left_second_div.innerHTML), left_second_div);

        // 5ì´ˆ ë’¤ì— ìë™ ì¬ì ‘ì†
        setTimeout(() => {
            clearInterval(interval);
            window.location.reload();
        }, 5000);

        appendMessage('\n' + 'ë°©ì— ë¬¸ì œê°€ ìƒê²¨ ì±„íŒ…ì´ ì¢…ë£Œ ë˜ì—ˆìŠµë‹ˆë‹¤.' + '\n', "chat-message-center");
        document.querySelector('#chat-message-refresh').style.display = 'block';
        document.querySelector('#chat-message-submit').style.display = 'none';
    };

    // ì†Œì¼“í†µì‹ ì´ ì—°ê²°ë˜ë©´ ì‹¤í–‰í•œë‹¤.
    chatSocket.onopen = function (e) {
        appendMessage('\n' + roomName + " ë°©ì— ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤." + '\n', "chat-message-center");
    }

    // ë§¨ì²˜ìŒì— ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ë¥¼ í•˜ê¸° ìœ„í•¨
    document.querySelector('#chat-message-input').focus();
    // ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ í•´ë‹¹ ì •ë³´ê°€ ì „ì†¡ë¨
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    // ì—”í„°ë¥¼ í•˜ë©´ í•´ë‹¹ inputì— ìˆëŠ” ì •ë³´ë¥¼ JSONí™” ì‹œì¼œì„œ chatSocketì— ì „ì†¡í•œë‹¤
    document.querySelector('#chat-message-submit').onclick = function (e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        document.querySelector('#chat-message-input').focus();

        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
        }
        // input ë¹„ìš´ë‹¤
        messageInputDom.value = '';
    };
</script>

</body>
</html>